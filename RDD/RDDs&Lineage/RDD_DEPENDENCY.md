# RDD DEPENDENCY

```
RDD 의존 관계는 RDD에 복원성을 부여하며, 스파크 job 및 태스크 생성에도 영향을 미침
```



## 1. RDD 의존 관계와 스파크 동작 매커니즘

```
스파크의 실행 모델은 방향성 비순환 그래프(DAG)에 기반함.
그래프는 정점(노드)과 두 정점을 잇는 간선으로 구성됨.
방향성 그래프는 간선이 한 정점에서 다른 정점을 가리키는 방향성이 있는 그래프를 의미함.
그 중 방향성 비순환 그래프는 간선의 방향을 따라 이동했을 때
같은 정점에 두번 이상 방문할 수 없도록 연결된 그래프를 의미함(순환하지 않는 그래프).

스파크의 DAG는 RDD를 정점으로 RDD 의존 관계를 간선으로 정의한 그래프를 의미함.
RDD의 변환 연산자를 호출할 때마다 새로운 정점(RDD)과 새로운 간선(의존 관계)이 생성됨.
변환 연산자로 생성된 새 RDD가 이전 RDD에 의존하므로 간선 방향은 자식 RDD(새 RDD)에서 부모RDD(이전 RDD)로 향함.
이러한 RDD 의존 관계 그래프를 RDD 계보라고 함.

RDD 의존 관계는 크게 두 가지 기본 유형으로 나눌 수 있는데, 좁은 의존 관계와 넓은(또는 셔플) 의존 관계가 그것임.
의존 관계의 유형에 따라 셔플링 실행 여부가 결정되며, 의존 관계의 유형은 셔플링 발생 규칙을 따름.
다시 말해 데이터를 다른 파티션으로 전송할 필요가 없는 변환 연산은 좁은 의존 관계를 형성함.
넓은 의존 관계는 그 반대로, 셔플링을 수행할 때마다 형성됨. 참고로 RDD를 조인하면 셔플링이 항상 발생함.

좁은 의존 관계는 다시 1대1 의존 관계와 범위형 의존 관계로 나눌 수 있음.
범위형 의존 관계는 여러 부모 RDD에 대한 의존 관계를 하나로 결합한 경우로 union 변환 연산자만 해당함.
1대1 의존 관계는 셔플링이 필요하지 않은 모든 변환 연산자에 사용함.
```



## 2. 스파크의 스테이지와 태스크

```
RDD 계보와 의존 관계는 스파크가 익스큐터에 보낼 세부 태스크를 구성할 때 중요하게 작용함.
스파크는 셔플링이 발생하는 지점을 기준으로 스파크 잡 하나를 여러 스테이지로 나눔.

각 스테이지 결과는 중간 파일의 형태로 익스큐터 머신의 로컬 디스크에 저장됨.
셔플이 일어난 후 스테이지에서는 이 중간 파일의 데이터를 적절한 파티션으로 읽어 들인 후 실행함.

스파크는 각 스테이지와 파티션별로 태스크를 생성해 익스큐터에게 전달함.
스테이지가 셔플링으로 끝나는 경우 이 단계의 태스크를 셔플-맵 태스크라고 함.
스테이지의 모든 태스크가 완료되면 드라이버는 다음 스테이지의 태스크를 생성하고 익스큐터에 전달함.
이 과정은 마지막 스테이지 결과를 드라이버로 반환할 때까지 계속함. 마지막 스테이지에 생성된 태스크를 결과 태스크라고 함.
```



## 3. 체크포인트로 RDD 계보 저장

```
변환 연산자를 계속 이어 붙이면 RDD 계보가 제약 없이 길어질 수 있음.
따라서 스파크는 전체 RDD를 안전한 스토리지에 보관할 수 있는 방법을 제공함.
RDD를 안전하게 보관하면 일부 노드에 장애가 발생해도 유실된 RDD 조각을 처음부터 다시 계산할 필요가 없음.
그 대신 스파크는 장애 발생 이전에 저장된 스냅샷을 사용해 이 지점부터 나머지 계보를 다시 계산함.
이 기능을 체크포인팅이라고 함.

체크포인팅을 실행하면 스파크는 RDD의 모든 데이터를 디스크에 저장함.
그러나 스파크는 단순히 캐시처럼 RDD의 데이터만 저장하는 것이 아니라 RDD의 계보까지 모두 저장함.
체크포인팅을 완료한 후에는 저장한 RDD를 다시 계산할 필요가 없으므로 해당 RDD 의존 관계와 부모 RDD 정보를 삭제함.

체크포인팅은 RDD의 checkpoint 메서드를 호출해 실행할 수 있음.
하지만 먼저 SparkContext.setCheckpointDir에 데이터를 저장할 디렉터리부터 지정해야 함.
보통은 HDFS 디렉터리를 사용하지만 로컬 디스크로 설정할 수도 있음.
checkpoint 메서드는 해당 RDD에 잡이 실행되기 전에 호출해야 하며,
그 이후 체크포인팅을 실제로 완료하려면 RDD에 행동 연산자 등을 호출해 잡을 실행하고 RDD를 구체화해야 함.

체크포인트는 언제 만들어야 할까?
DAG가 길게 늘어진 RDD를 사용할 경우(즉, RDD에 의존 관계가 많은 경우) 노드에 장애가 발생했을 때
유실된 데이터를 복구하는 데 오랜 시간이 걸릴 수 있음.
다시 말해 지금까지 호출한 모든 변환 연산자를 사용해 유실된 RDD를 처음부터 다시 계산하는 것보다는
체크포인트 파일에 저장해 둔 데이터를 읽어 들이는 편이 훨씬 더 빠를 수 있음.
```



