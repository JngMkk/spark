# Accumulator&Broadcast variable

```
누적 변수는 스파크 프로그램의 전역 상태를 유지할 수 있으며,
공유 변수로 태스크 및 파티션이 공통으로 사용하는 데이터를 공유할 수 있음.
```



## 1. 누적 변수로 실행자에서 데이터 가져오기

```
누적 변수는 스파크 프로그램에 카운터를 추가하기 위해 일반적으로 사용되는 익스큐터에서 변수를 공유함.
스파크 프로그램을 갖고 있고 처리된 전체 레코드나 에러 또는 둘 다를 알고 싶다면 두 가지 방법으로 수행할 수 있음.

하나는 에러나 전체 레코드를 계산할 때마다 특정 로직을 추가하는 것. 그래서 가능한 모든 계산을 처리할 때 복잡할 것임.
또 다른 하나는 로직과 코드 흐름을 그대로 두고 누적 변수를 추가하는 것.

누적 변수는 값을 추가해 변경할 수도 있음.

longAccumulator : 64비트 정수의 합, 개수, 평균을 계산
dobuleAccumulator : 배정밀도 부동소수점에 대한 합계, 개수, 평균을 계산
collectionAccumulator[T] : 엘리먼트 리스트를 수집
    def collectionAccumulator[T](name: String):
    	org.apache.spark.util.CollectionAccumulator[T]
    def collectionAccumulator[T]: org.apache.spark.util.CollectionAccumulator[T]

모든 누적 변수는 AccumulatorV2 클래스 기반으로 구축됨.
동일한 로직을 따르면서 프로젝트에서 사용할 수 있는 매우 복잡하고 사용자 정의한 누적 변수를 생성할 수 있음.
    class MyAccumulator extends AccumulatorV2[Int, Int] {
        // 간단히 boolean 값인지 확인
        override def isZero: Boolean = ???

        // 특정 누적 변수를 복사해 다른 누적 변수를 생성하는 함수
        override def copy(): AccumulatorV2[Int, Int] = ???

        // 값을 재설정
        override def reset(): Unit = ???

        // 누적 변수에 특정 값을 추가하는 함수
        override def add(v: Int): Unit = ???

        // 2개의 누적 변수를 병합하는 로직
        override def merge(other: AccumulatorV2[Int, Int]): Unit = ???

        // 누적 변수의 값을 리턴하는 함수
        override def value: Int = ???
    }

누적 변수는 여러 실행자가 공유하는 변수로 값을 더하는 연산만 허용함.
누적 변수를 사용해 스파크 잡의 전역 합계나 카운터를 구현할 수 있음.

누적 변수는 SparkContext.accumulator(initialValue)를 호출해 생성함.
또 sc.accumulator(initialValue, "accumulatorName")을 호출하면 누적 변수 이름을 지정할 수 있음.
누적 변수 이름을 지정하면 스파크 웹UI의 스테이지 상세 페이지에서도 이 변수를 볼 수 있으며,
태스크의 진행 상황을 추적하는 데 사용할 수 있음.

누적 변수 값은 add 메서드나 += 연산자를 사용해 더함. 또 value 메서드로 변수 값을 가져올 수 있음.
그러나 누적 변수 값은 오직 드라이버만 참조할 수 있음. 익스큐터가 누적 변수 값에 접근을 시도하면 예외가 발생함.
```



## 2. 공유 변수로 익스큐터에 데이터 전송

```
모든 익스큐터에서 사용할 수 있는 공유 번수. 브로드캐스트 변수는 드라이버에서 한 번 생성되면 익스큐터에서만 읽을 수 있음.
정수 타입처럼 단순한 데이터 타입으로 이해할 수도 있지만 개념적으로는 단순한 변수보다 훨씬 크게 사용될 수 있음.
전체 데이터셋이 스파크 클러스터에서 전파될 수 있어서 익스큐터에서는 브로드캐스트 변수의 데이터에 접근할 수 있음.
익스큐터 내부에서 실행되는 모든 태스크는 모두 브로드캐스트 변수에 접근할 수 있음.

브로드캐스트에서는 모든 익스큐터에서 브로드캐스트된 데이터에 접근할 수 있는 다양한 최적화 방법을 사용함.
따라서 브로드캐스트된 데이터셋의 크기는 반드시 해결해야 하는 중요한 과제임.
드라이버에 연결하고 데이터셋을 얻으려는 100개 또는 1000개의 익스큐터는 기대할 수 없을 것임.
대신 익스큐터는 HTTP 커넥션으로 데이터를 가져오고 데이터를 클러스터 간에 torrent로 배포되는 비트토렌트와 비슷한 최신 기능을 제공함.
해당 기능은 각 익스큐터가 드라이버에서 데이터를 하나씩 가져 오는 방식이 아닌(익스큐터를 많이 사용하는 경우 드라이버에 장애를 발생시킬 수 있는 방식)
모든 익스큐터에 브로드캐스트 변수를 배포할 수 있는 더 확장성 있는 방법을 사용하는 것이 좋음.

드라이버는 데이터를 브로드캐스트만 할 수 있고 참조 데이터를 RDD로 브로드캐스트할 수 없음.
이는 드라이버만 RDD를 해석하는 방법을 알고 있고 익스큐터는 처리 중인 데이터의 특정 파티션만 알 수 있기 때문.

브로드캐스트의 동작은 드라이버에서 먼저 직렬화된 객체를 작은 청크로 나누고, 해당 청크를 드라이버의 BlockManager에 저장하게 동작함.
코드가 익스큐터에서 실행될 수 있게 직렬화되면 각 익스큐터는 먼저 익스큐터 내부의 BlockManager에서 객체를 얻음.
이전에 브로드캐스트 변수를 얻었다면 이를 찾아서 사용함.
그러나 브로드캐스트 변수가 존재하지 않으면 익스큐터는 원격으로 드라이버 또는 다른 익스큐터에서 작은 청크를 얻음.
익스큐터는 일단 청크를 얻으면 해당 청크를 익스큐터의 BlockManager에 넣고 다른 익스큐터에서 청크를 요청하면 전달할 수 있게 준비함.
이는 드라이버가 브로드캐스트 데이터의 여러 복사본(익스큐터당 하나)을 보내려할 때 병목 현상이 발생하는 것을 방지할 수 있음.

공유 변수는 누적 변수와 마찬가지로 여러 클러스터 노드가 공동으로 사용할 수 있는 변수.
하지만 공유 변수는 누적 변수와 달리 익스큐터가 수정할 수 없음.
오직 드라이버만이 공유 변수를 생성하며, 익스큐터에서는 읽기 연산만 가능함.

익스큐터 대다수가 대용량 데이터를 공통으로 사용할 때는 이 데이터를 공유 변수로 만드는 것이 좋음.
보통은 드라이버에서 생성한 변수를 태스크에서 사용하면 스파크는 이 변수를 직렬화하고 태스크와 함께 익스큐터로 전송함.
하지만 드라이버 프로그램은 동일한 변수를 여러 job에 걸쳐 재사용할 수 있고
job 하나를 수행할 때도 여러 태스크가 동일한 익스큐터에 할당될 수 있으므로,
변수를 필요 이상으로 여러 번 직렬화해 네트워크로 전송하는 상황이 발생할 수도 있음.
이때는 데이터를 더욱 최적화된 방식으로 단 한 번만 전송하는 공유 변수를 사용하는 편이 좋음.

공유 변수는 Broadcast 타입의 객체를 반환하는 SparkContext.broadcast(value) 메서드로 생성함.
value 인수에는 직렬화 가능한 모든 종류의 객체를 전달할 수 있음.
익스큐터는 Broadcast.value 메서드로 생성된 공유 변수를 참조함.
익스큐터는 공유 변수 값을 읽어 들이기 전에 먼저 공유 변수를 익스큐터에 로드했는지 확인함.
아직 공유 변수를 로드하지 않았다면 익스큐터는 드라이버 공유 변수에 데이터를 청크 단위로 나누어 전송해줄 것을 요청함.
스파크는 이런 풀링 기반 방식을 이용해 job 시작 과정에서 발생할 수 있는 네트워크 정체 현상을 방지함.

공유 변수 값을 참조할 때는 항상 value 메서드를 사용해야 함.
그렇지 않고 공유 변수에 직접 접근하면 스파크는 이 변수를 자동으로 직렬화해 태스크와 함께 전송함.
이렇게 하면 공유 변수를 사용하는 이유, 즉 성능상 이득을 완전히 잃어버리게 됨.
```



### 1) 공유 변수를 임시 제거 또는 완전 삭제

```
더 이상 필요하지 않은 공유 변수는 destroy를 호출해 완전히 삭제할 수 있음.
destory 메서드는 모든 공유 변수 정보를 익스큐터와 드라이버에서 제거하고 변수를 더 이상 사용할 수 없게 함.

또는 unpersist 메서드를 호출해 공유 변수 값을 익스큐터의 캐시에서 제거할 수 있음.
unpersist를 호출한 후에 공유 변수를 사용하면 공유 변수의 데이터를 익스큐터로 다시 전송함.

마지막으로 스파크는 공유 변수가 스코프를 벗어나면(즉, 공유 변수의 모든 참조가 사라지면)
자동으로 unpersist를 호출하므로 사용자가 이 메서드를 명시적으로 호출할 필요는 없음.
그 대신 드라이버 프로그램에서 공유 변수의 참조를 직접 제거할 수 있음.
```



### 2) 공유 변수와 관련된 스파크 매개변수

```
spark.broadcast.compress
	공유 변수를 전송하기 전에 데이터를 압축할지 여부를 지정함(default : true)
	공유 변수는 spark.io.compression.codec에 지정된 코덱으로 압축함.

spark.broadcast.blockSize
	공유 변수를 전송하는 데 사용하는 데이터 청크의 크기를 설정함(default : 4m)

spark.python.worker.reuse
	파이썬의 공유 변수 성능에 큰 영향을 주는 매개변수(default: true)
	워커를 재사용하지 않으면 각 태스크별로 공유 변수를 전송해야 함.
```

